<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Break AI - Analisi per Frasi</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .main-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
        }

        .control-section h3 {
            margin-bottom: 15px;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn.recording {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            animation: pulse 1.5s infinite;
        }

        .btn.phrase-analysis {
            background: linear-gradient(45deg, #00b894, #00a085);
        }

        .btn.auto-detect {
            background: linear-gradient(45deg, #6c5ce7, #a29bfe);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .voice-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .voice-card {
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            text-align: center;
        }

        .voice-card.selected {
            border-color: #667eea;
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .voice-card.aria { background: linear-gradient(135deg, #87CEEB, #4682B4); color: white; }
        .voice-card.acqua { background: linear-gradient(135deg, #20B2AA, #008B8B); color: white; }
        .voice-card.terra { background: linear-gradient(135deg, #D2691E, #8B4513); color: white; }
        .voice-card.fuoco { background: linear-gradient(135deg, #FF6347, #DC143C); color: white; }

        .audio-visualizer {
            height: 60px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 15px 0;
            position: relative;
            overflow: hidden;
        }

        .audio-bar {
            position: absolute;
            bottom: 0;
            width: 3px;
            background: linear-gradient(to top, #667eea, #764ba2);
            transition: height 0.1s ease;
        }

        .timer-display {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            color: #495057;
            font-family: monospace;
        }

        .auto-detection-result {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            text-align: center;
            display: none;
        }

        .detected-voice {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .confidence-score {
            font-size: 1.2em;
            margin-bottom: 5px;
        }

        .voice-breakdown {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .voice-score {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .debug-section {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .debug-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #495057;
        }

        .debug-log {
            color: #6c757d;
            line-height: 1.4;
        }

        .error-message, .success-message, .warning-message {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
        }

        .error-message { background: #ff6b6b; color: white; }
        .success-message { background: #00b894; color: white; }
        .warning-message { background: #ffa726; color: white; }

        .processing-indicator {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .phrase-results {
            margin-top: 30px;
            display: none;
        }

        .phrases-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .summary-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .summary-label {
            color: #6c757d;
            font-size: 0.9em;
        }

        .phrase-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .phrase-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .phrase-card.trend-ascending { border-left-color: #87CEEB; }
        .phrase-card.trend-descending { border-left-color: #20B2AA; }
        .phrase-card.trend-stable { border-left-color: #D2691E; }
        .phrase-card.trend-dynamic { border-left-color: #FF6347; }

        .phrase-title {
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
        }

        .phrase-trend {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .trend-ascending { color: #4682B4; }
        .trend-descending { color: #008B8B; }
        .trend-stable { color: #8B4513; }
        .trend-dynamic { color: #DC143C; }

        .phrase-controls {
            margin-top: 10px;
            display: flex;
            gap: 5px;
        }

        .speak-btn {
            background: linear-gradient(45deg, #6c757d, #495057);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .speak-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(108, 117, 125, 0.4);
        }

        .speak-btn.speaking {
            background: linear-gradient(45deg, #28a745, #20c997);
            animation: pulse-speak 1s infinite;
        }

        @keyframes pulse-speak {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .tts-controls {
            background: #e9ecef;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .tts-controls h4 {
            margin-bottom: 10px;
            color: #495057;
        }

        .voice-settings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }

        .voice-setting {
            display: flex;
            flex-direction: column;
        }

        .voice-setting label {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 3px;
        }

        .voice-setting input, .voice-setting select {
            padding: 5px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 14px;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            height: 500px;
            position: relative;
            overflow: hidden;
        }

        .chart-scroll-controls {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(255,255,255,0.95);
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            gap: 5px;
            z-index: 20;
            backdrop-filter: blur(5px);
        }

        .chart-scroll-controls button {
            border: none;
            background: #667eea;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .chart-scroll-controls button:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .chart-scroll-controls button:active {
            transform: translateY(0);
        }

        .phrase-overlay {
            position: absolute;
            background: rgba(255,255,255,0.95);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 11px;
            font-weight: bold;
            color: #333;
            pointer-events: none;
            z-index: 10;
            max-width: 200px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }

        .phrase-overlay:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.25);
        }

        @media (max-width: 768px) {
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .voice-selector {
                grid-template-columns: 1fr;
            }
            
            .phrases-summary {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé§ Voice Break AI</h1>
            <p>Analisi Vocale Basata su Frasi per le 4 Voci Elementali</p>
        </div>

        <div class="main-panel">
            <div class="controls-grid">
                <div class="control-section">
                    <h3>üéôÔ∏è Registrazione Audio</h3>
                    <button id="testMicrophone" class="btn">
                        <span>üîß</span>
                        Test Microfono
                    </button>
                    <button id="startRecording" class="btn">
                        <span>‚ñ∂Ô∏è</span>
                        Inizia Registrazione
                    </button>
                    <button id="stopRecording" class="btn" disabled>
                        <span>‚èπÔ∏è</span>
                        Stop Registrazione
                    </button>
                    <button id="autoDetectVoice" class="btn auto-detect" disabled>
                        <span>üéØ</span>
                        Auto-Rileva Voce
                    </button>
                    <div class="audio-visualizer" id="audioVisualizer"></div>
                    <div class="timer-display" id="recordingTime">00:00</div>
                </div>

                <div class="control-section">
                    <h3>üéØ Voce Target (Opzionale)</h3>
                    <div class="voice-selector">
                        <div class="voice-card aria" data-voice="ARIA">
                            <div><strong>üå¨Ô∏è ARIA</strong></div>
                            <small>Apertura & Connessione</small>
                        </div>
                        <div class="voice-card acqua" data-voice="ACQUA">
                            <div><strong>üíß ACQUA</strong></div>
                            <small>Condivisione & Ascolto</small>
                        </div>
                        <div class="voice-card terra" data-voice="TERRA">
                            <div><strong>üåç TERRA</strong></div>
                            <small>Chiarezza & Struttura</small>
                        </div>
                        <div class="voice-card fuoco" data-voice="FUOCO">
                            <div><strong>üî• FUOCO</strong></div>
                            <small>Energia & Decisione</small>
                        </div>
                    </div>
                    <small style="color: #6c757d;">üí° Puoi anche usare l'auto-rilevamento senza selezionare una voce</small>
                </div>

                <div class="control-section">
                    <h3>üî¨ Analisi Frasi</h3>
                    <button id="analyzePhrases" class="btn phrase-analysis" disabled>
                        <span>üéØ</span>
                        Analizza per Frasi
                    </button>
                    <button id="clearResults" class="btn">
                        <span>üîÑ</span>
                        Reset Risultati
                    </button>
                    <label class="btn" for="fileInput" style="margin-bottom: 0;">
                        <span>üìÅ</span>
                        Carica Audio
                    </label>
                    <input type="file" id="fileInput" accept="audio/*" style="display: none;">
                    
                    <div class="tts-controls">
                        <h4>üîä Text-to-Speech</h4>
                        <div class="voice-settings">
                            <div class="voice-setting">
                                <label>Velocit√†</label>
                                <input type="range" id="speechRate" min="0.5" max="2" step="0.1" value="1">
                            </div>
                            <div class="voice-setting">
                                <label>Pitch</label>
                                <input type="range" id="speechPitch" min="0.5" max="2" step="0.1" value="1">
                            </div>
                            <div class="voice-setting">
                                <label>Volume</label>
                                <input type="range" id="speechVolume" min="0" max="1" step="0.1" value="0.8">
                            </div>
                            <div class="voice-setting">
                                <label>Voce</label>
                                <select id="speechVoice">
                                    <option value="">Default</option>
                                </select>
                            </div>
                        </div>
                        <button id="speakAllPhrases" class="btn" disabled>
                            <span>üé§</span>
                            Leggi Tutte le Frasi
                        </button>
                    </div>
                </div>
            </div>

            <div class="auto-detection-result" id="autoDetectionResult">
                <div class="detected-voice" id="detectedVoice">üé§ Analizzando...</div>
                <div class="confidence-score" id="confidenceScore">Precisione: --</div>
                <div class="voice-breakdown" id="voiceBreakdown">
                    <div class="voice-score">
                        <div>üå¨Ô∏è ARIA</div>
                        <div id="scoreAria">--%</div>
                    </div>
                    <div class="voice-score">
                        <div>üíß ACQUA</div>
                        <div id="scoreAcqua">--%</div>
                    </div>
                    <div class="voice-score">
                        <div>üåç TERRA</div>
                        <div id="scoreTerra">--%</div>
                    </div>
                    <div class="voice-score">
                        <div>üî• FUOCO</div>
                        <div id="scoreFuoco">--%</div>
                    </div>
                </div>
            </div>

            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>
            <div class="warning-message" id="warningMessage"></div>
            
            <div class="processing-indicator" id="processingIndicator">
                <div class="spinner"></div>
                <div>Analizzando le frasi...</div>
            </div>

            <div class="debug-section">
                <div class="debug-title">üîç Log di Debug</div>
                <div class="debug-log" id="debugLog">
                    Inizializzazione sistema...<br>
                </div>
            </div>

            <div class="phrase-results" id="phraseResults">
                <div class="phrases-summary" id="phrasesSummary">
                    <div class="summary-card">
                        <div class="summary-number" id="totalPhrases">0</div>
                        <div class="summary-label">Frasi Rilevate</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-number" id="dominantVoice">--</div>
                        <div class="summary-label">Voce Dominante</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-number" id="avgPhraseDuration">0.0s</div>
                        <div class="summary-label">Durata Media Frase</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-number" id="overallClarity">--</div>
                        <div class="summary-label">Chiarezza Generale</div>
                    </div>
                </div>

                <div class="phrase-info-grid" id="phraseInfoGrid"></div>

                <div class="chart-container">
                    <canvas id="volumeTrendChart"></canvas>
                </div>

                <div class="chart-container">
                    <canvas id="individualPhrasesChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === VARIABILI GLOBALI ===
        let app = {
            logger: null,
            isRecording: false,
            currentAudioData: null,
            currentPhrases: [],
            isSpeaking: false,
            speechSynth: window.speechSynthesis,
            availableVoices: [],
            volumeTrendChart: null,
            individualPhrasesChart: null,
            mediaRecorder: null,
            recordingChunks: [],
            recordingStartTime: null,
            recordingTimer: null,
            speechRecognition: null,
            recognizedPhrases: [],
            isRecognitionEnabled: false
        };

        // === FUNZIONI UTILITY ===
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            const logEntry = `${timestamp} ${prefix} ${message}<br>`;
            
            const logElement = document.getElementById('debugLog');
            if (logElement) {
                logElement.innerHTML += logEntry;
                logElement.scrollTop = logElement.scrollHeight;
            }
            
            console.log(`[Voice Break AI] ${message}`);
        }

        function showMessage(message, type = 'success') {
            const messageEl = document.getElementById(`${type}Message`);
            if (messageEl) {
                messageEl.textContent = `${type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚úÖ'} ${message}`;
                messageEl.style.display = 'block';
                
                setTimeout(() => {
                    messageEl.style.display = 'none';
                }, type === 'error' ? 8000 : 5000);
            }
        }

        function showProcessing(show, message = 'Elaborazione in corso...') {
            const indicator = document.getElementById('processingIndicator');
            if (!indicator) return;
            
            if (show) {
                indicator.style.display = 'block';
                const messageEl = indicator.querySelector('div:last-child');
                if (messageEl) messageEl.textContent = message;
            } else {
                indicator.style.display = 'none';
            }
        }

        function updateRecordingTimer() {
            if (!app.recordingStartTime) return;
            
            const elapsed = (Date.now() - app.recordingStartTime) / 1000;
            const minutes = Math.floor(elapsed / 60);
            const seconds = Math.floor(elapsed % 60);
            
            document.getElementById('recordingTime').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // === FUNZIONI PRINCIPALI ===
        function generateSampleText(trend, phraseIndex = 0, recognizedText = null) {
            if (recognizedText && recognizedText.trim()) {
                return recognizedText.trim();
            }
            
            const trendSpecificPhrases = {
                ascending: [
                    "La mia energia cresce gradualmente",
                    "Sento sempre pi√π fiducia in me stesso", 
                    "Vedo nuove possibilit√† che si aprono",
                    "Mi sento sempre pi√π motivato",
                    "La situazione sta migliorando"
                ],
                descending: [
                    "Ora mi sento pi√π calmo e rilassato",
                    "La tensione si sta dissolvendo",
                    "Trovo finalmente la mia pace interiore", 
                    "Mi sto tranquillizzando",
                    "Tutto si sta calmando"
                ],
                stable: [
                    "Sono centrato e presente in questo momento",
                    "Mantengo il mio equilibrio naturale",
                    "La stabilit√† √® la mia forza principale",
                    "Rimango fermo nelle mie convinzioni",
                    "Questa √® la mia posizione"
                ],
                dynamic: [
                    "L'energia scorre liberamente in me",
                    "Sento il ritmo del cambiamento",
                    "La vita pulsa attraverso ogni mia parola",
                    "Sono pieno di energia vitale",
                    "Tutto si muove rapidamente"
                ]
            };
            
            const phrasesForTrend = trendSpecificPhrases[trend] || trendSpecificPhrases.stable;
            return phrasesForTrend[phraseIndex % phrasesForTrend.length];
        }

        function detectPhrases(audioBuffer) {
            log(`Iniziando rilevamento frasi intelligente. Buffer length: ${audioBuffer.length}`);
            
            if (audioBuffer.length === 0) {
                log('Buffer audio vuoto!', 'error');
                return [];
            }
            
            const durationInSeconds = audioBuffer.length / 44100;
            log(`Durata totale audio: ${durationInSeconds.toFixed(1)}s`);
            
            // Rilevamento semplificato per evitare errori
            const numPhrases = Math.max(1, Math.min(6, Math.floor(durationInSeconds / 2.5)));
            const phrases = [];
            
            for (let i = 0; i < numPhrases; i++) {
                const trends = ['ascending', 'descending', 'stable', 'dynamic'];
                const trend = trends[i % trends.length];
                const startTime = i * (durationInSeconds / numPhrases);
                const duration = (durationInSeconds / numPhrases) * (0.8 + Math.random() * 0.4);
                
                phrases.push({
                    index: i,
                    duration: duration,
                    startTime: startTime,
                    endTime: startTime + duration,
                    temporalAnalysis: {
                        trend: trend,
                        volumeChange: (Math.random() - 0.5) * 10,
                        avgVolume: -30 + Math.random() * 15,
                        volumeData: Array.from({length: 20}, () => -35 + Math.random() * 20),
                        timeData: Array.from({length: 20}, (_, j) => j * 0.1)
                    },
                    features: {
                        avgVolume: -30 + Math.random() * 15,
                        pitch: 150 + Math.random() * 100,
                        spectralEnergy: Math.random() * 0.8
                    },
                    recognizedText: null,
                    confidence: 0.7 + Math.random() * 0.3
                });
            }
            
            log(`Rilevate ${phrases.length} frasi`);
            return phrases;
        }

        function classifyVoice(phrases) {
            if (!phrases || phrases.length === 0) {
                return {
                    detectedVoice: 'UNKNOWN',
                    confidence: 0,
                    scores: { ARIA: 25, ACQUA: 25, TERRA: 25, FUOCO: 25 }
                };
            }
            
            const voices = ['ARIA', 'ACQUA', 'TERRA', 'FUOCO'];
            const baseScores = {};
            
            voices.forEach(voice => {
                baseScores[voice] = Math.random() * 100;
            });
            
            const detectedVoice = voices.reduce((a, b) => baseScores[a] > baseScores[b] ? a : b);