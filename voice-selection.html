<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Break AI - Allenamento Vocale</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(0,0,0,0.1);
            padding: 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 1.8em;
            font-weight: 700;
        }

        .back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 10px 20px;
            border-radius: 20px;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }

        .training-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .panel {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .panel:hover {
            transform: translateY(-5px);
        }

        .panel-title {
            font-size: 1.6em;
            font-weight: 700;
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .voice-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .voice-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 3px solid transparent;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .voice-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--voice-color);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .voice-card:hover::before,
        .voice-card.selected::before {
            transform: scaleX(1);
        }

        .voice-card.selected {
            border-color: var(--voice-color);
            background: linear-gradient(135deg, var(--voice-bg) 0%, var(--voice-bg-light) 100%);
        }

        .voice-card.aria {
            --voice-color: #74b9ff;
            --voice-bg: rgba(116, 185, 255, 0.1);
            --voice-bg-light: rgba(116, 185, 255, 0.05);
        }

        .voice-card.acqua {
            --voice-color: #00b894;
            --voice-bg: rgba(0, 184, 148, 0.1);
            --voice-bg-light: rgba(0, 184, 148, 0.05);
        }

        .voice-card.terra {
            --voice-color: #fdcb6e;
            --voice-bg: rgba(253, 203, 110, 0.1);
            --voice-bg-light: rgba(253, 203, 110, 0.05);
        }

        .voice-card.fuoco {
            --voice-color: #fd79a8;
            --voice-bg: rgba(253, 121, 168, 0.1);
            --voice-bg-light: rgba(253, 121, 168, 0.05);
        }

        .voice-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
            display: block;
        }

        .voice-name {
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
        }

        .voice-description {
            font-size: 0.9em;
            color: #666;
            margin-top: 8px;
        }

        .recording-controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
        }

        .record-btn {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: none;
            font-size: 2.5em;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .record-btn.idle {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .record-btn.recording {
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            color: white;
            animation: pulse 1.5s infinite;
        }

        .record-btn.processing {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .recording-status {
            font-size: 1.1em;
            font-weight: 600;
            color: #2c3e50;
            margin-top: 10px;
        }

        .timer {
            font-size: 1.5em;
            font-weight: 700;
            color: #e74c3c;
            font-family: monospace;
        }

        .feedback-panel {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 25px;
            margin-top: 25px;
            border-left: 5px solid #3498db;
        }

        .feedback-score {
            text-align: center;
            margin-bottom: 20px;
        }

        .score-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            font-weight: 700;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .score-excellent { background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); }
        .score-good { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); }
        .score-needs-work { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }

        .feedback-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .feedback-metric {
            background: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .feedback-metric:hover {
            border-color: #3498db;
            transform: translateY(-2px);
        }

        .metric-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 1.3em;
            font-weight: 700;
            color: #2c3e50;
        }

        .metric-bar {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .metric-fill {
            height: 100%;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            transition: width 0.5s ease;
        }

        .suggestions {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid #f39c12;
        }

        .suggestions h4 {
            color: #e67e22;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .suggestions ul {
            list-style: none;
            padding: 0;
        }

        .suggestions li {
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
            position: relative;
            padding-left: 25px;
        }

        .suggestions li:last-child {
            border-bottom: none;
        }

        .suggestions li::before {
            content: '💡';
            position: absolute;
            left: 0;
            top: 8px;
        }

        .progress-panel {
            grid-column: 1 / -1;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }

        .progress-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            position: relative;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--stat-color);
            border-radius: 15px 15px 0 0;
        }

        .stat-card.sessions { --stat-color: #3498db; }
        .stat-card.improvement { --stat-color: #27ae60; }
        .stat-card.accuracy { --stat-color: #f39c12; }
        .stat-card.streak { --stat-color: #e74c3c; }

        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .waveform-display {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 2px solid #ecf0f1;
        }

        .waveform-canvas {
            width: 100%;
            height: 200px;
            background: #f8f9fa;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 1.1em;
        }

        .exercises-panel {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            margin-top: 30px;
        }

        .exercise-list {
            display: grid;
            gap: 15px;
        }

        .exercise-item {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .exercise-item:hover {
            border-color: #3498db;
            transform: translateY(-2px);
        }

        .exercise-item.completed {
            background: linear-gradient(135deg, #d5f4e6 0%, #c8e6c9 100%);
            border-color: #27ae60;
        }

        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .exercise-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #2c3e50;
        }

        .exercise-difficulty {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .difficulty-easy { background: #d5f4e6; color: #27ae60; }
        .difficulty-medium { background: #fff3cd; color: #f39c12; }
        .difficulty-hard { background: #f8d7da; color: #e74c3c; }

        .exercise-description {
            color: #666;
            margin-bottom: 15px;
        }

        .exercise-stats {
            display: flex;
            gap: 20px;
            font-size: 0.9em;
            color: #666;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success { background: #27ae60; }
        .notification.error { background: #e74c3c; }
        .notification.warning { background: #f39c12; }
        .notification.info { background: #3498db; }

        @media (max-width: 1024px) {
            .training-grid {
                grid-template-columns: 1fr;
            }
            
            .voice-selector {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .voice-selector {
                grid-template-columns: 1fr;
            }
            
            .feedback-details {
                grid-template-columns: 1fr;
            }
            
            .progress-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🎤 Voice Break AI - Allenamento Vocale</h1>
        <a href="index.html" class="back-btn">← Home</a>
    </div>

    <div class="container">
        <div class="training-grid">
            <!-- Pannello di Registrazione -->
            <div class="panel">
                <h2 class="panel-title">🎯 Allenamento Voce</h2>
                
                <div class="voice-selector">
                    <div class="voice-card aria" data-voice="aria">
                        <span class="voice-icon">🌬️</span>
                        <div class="voice-name">ARIA</div>
                        <div class="voice-description">Apertura e connessione</div>
                    </div>
                    
                    <div class="voice-card acqua" data-voice="acqua">
                        <span class="voice-icon">💧</span>
                        <div class="voice-name">ACQUA</div>
                        <div class="voice-description">Condivisione e ascolto</div>
                    </div>
                    
                    <div class="voice-card terra" data-voice="terra">
                        <span class="voice-icon">🌍</span>
                        <div class="voice-name">TERRA</div>
                        <div class="voice-description">Chiarezza e struttura</div>
                    </div>
                    
                    <div class="voice-card fuoco" data-voice="fuoco">
                        <span class="voice-icon">🔥</span>
                        <div class="voice-name">FUOCO</div>
                        <div class="voice-description">Energia e decisione</div>
                    </div>
                </div>

                <div class="recording-controls">
                    <button class="record-btn idle" id="recordBtn">
                        🎤
                    </button>
                    <div class="recording-status" id="recordingStatus">
                        Seleziona una voce e clicca per iniziare
                    </div>
                    <div class="timer" id="timer">00:00</div>
                </div>

                <div class="waveform-display" id="waveformDisplay" style="display: none;">
                    <div class="waveform-canvas" id="waveformCanvas">
                        Analisi in tempo reale...
                    </div>
                </div>
            </div>

            <!-- Pannello di Feedback -->
            <div class="panel">
                <h2 class="panel-title">📊 Feedback AI</h2>
                
                <div class="feedback-panel" id="feedbackPanel">
                    <div class="feedback-score">
                        <div class="score-circle score-excellent" id="scoreCircle">
                            <span id="scoreValue">--</span>
                        </div>
                        <div>Punteggio Voce</div>
                    </div>

                    <div class="feedback-details">
                        <div class="feedback-metric">
                            <div class="metric-label">Tono</div>
                            <div class="metric-value" id="toneValue">--</div>
                            <div class="metric-bar">
                                <div class="metric-fill" id="toneFill" style="width: 0%"></div>
                            </div>
                        </div>

                        <div class="feedback-metric">
                            <div class="metric-label">Volume</div>
                            <div class="metric-value" id="volumeValue">--</div>
                            <div class="metric-bar">
                                <div class="metric-fill" id="volumeFill" style="width: 0%"></div>
                            </div>
                        </div>

                        <div class="feedback-metric">
                            <div class="metric-label">Ritmo</div>
                            <div class="metric-value" id="rhythmValue">--</div>
                            <div class="metric-bar">
                                <div class="metric-fill" id="rhythmFill" style="width: 0%"></div>
                            </div>
                        </div>

                        <div class="feedback-metric">
                            <div class="metric-label">Chiarezza</div>
                            <div class="metric-value" id="clarityValue">--</div>
                            <div class="metric-bar">
                                <div class="metric-fill" id="clarityFill" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <div class="suggestions" id="suggestions" style="display: none;">
                        <h4>💡 Suggerimenti per Migliorare</h4>
                        <ul id="suggestionsList">
                            <!-- Suggerimenti dinamici -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pannello Progressi -->
        <div class="progress-panel">
            <h2 class="panel-title">📈 I Tuoi Progressi</h2>
            
            <div class="progress-stats">
                <div class="stat-card sessions">
                    <div class="stat-number" id="sessionsCount">0</div>
                    <div class="stat-label">Sessioni Totali</div>
                </div>
                
                <div class="stat-card improvement">
                    <div class="stat-number" id="improvementPercent">+0%</div>
                    <div class="stat-label">Miglioramento</div>
                </div>
                
                <div class="stat-card accuracy">
                    <div class="stat-number" id="accuracyPercent">--%</div>
                    <div class="stat-label">Precisione Media</div>
                </div>
                
                <div class="stat-card streak">
                    <div class="stat-number" id="streakDays">0</div>
                    <div class="stat-label">Giorni Consecutivi</div>
                </div>
            </div>
        </div>

        <!-- Pannello Esercizi -->
        <div class="exercises-panel">
            <h2 class="panel-title">🎯 Esercizi Guidati</h2>
            
            <div class="exercise-list">
                <div class="exercise-item" onclick="startExercise('aria-basics')">
                    <div class="exercise-header">
                        <div class="exercise-title">🌬️ Fondamenti dell'Aria</div>
                        <div class="exercise-difficulty difficulty-easy">Facile</div>
                    </div>
                    <div class="exercise-description">
                        Impara a modulare il tono ascendente e il volume crescente tipici della voce Aria
                    </div>
                    <div class="exercise-stats">
                        <span>⏱️ 10 min</span>
                        <span>🎯 Tono, Volume</span>
                        <span>⭐ 4.8/5</span>
                    </div>
                </div>

                <div class="exercise-item" onclick="startExercise('acqua-pauses')">
                    <div class="exercise-header">
                        <div class="exercise-title">💧 Pause e Fluidità</div>
                        <div class="exercise-difficulty difficulty-medium">Medio</div>
                    </div>
                    <div class="exercise-description">
                        Padroneggia le pause lunghe e la discesa tonale della voce Acqua
                    </div>
                    <div class="exercise-stats">
                        <span>⏱️ 15 min</span>
                        <span>🎯 Pause, Tono</span>
                        <span>⭐ 4.6/5</span>
                    </div>
                </div>

                <div class="exercise-item" onclick="startExercise('terra-structure')">
                    <div class="exercise-header">
                        <div class="exercise-title">🌍 Struttura e Stabilità</div>
                        <div class="exercise-difficulty difficulty-medium">Medio</div>
                    </div>
                    <div class="exercise-description">
                        Sviluppa la costanza ritmica e la chiarezza della voce Terra
                    </div>
                    <div class="exercise-stats">
                        <span>⏱️ 12 min</span>
                        <span>🎯 Ritmo, Chiarezza</span>
                        <span>⭐ 4.7/5</span>
                    </div>
                </div>

                <div class="exercise-item" onclick="startExercise('fuoco-energy')">
                    <div class="exercise-header">
                        <div class="exercise-title">🔥 Energia e Velocità</div>
                        <div class="exercise-difficulty difficulty-hard">Difficile</div>
                    </div>
                    <div class="exercise-description">
                        Affina l'energia esplosiva e il ritmo incalzante della voce Fuoco
                    </div>
                    <div class="exercise-stats">
                        <span>⏱️ 20 min</span>
                        <span>🎯 Energia, Ritmo</span>
                        <span>⭐ 4.9/5</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class VoiceTrainingApp {
            constructor() {
                this.selectedVoice = null;
                this.isRecording = false;
                this.isProcessing = false;
                this.recordingTime = 0;
                this.timerInterval = null;
                this.mediaRecorder = null;
                this.audioChunks = [];
                
                // Dati di progressi iniziali
                this.progressData = {
                    sessions: 0,
                    improvement: 0,
                    accuracy: 0,
                    streak: 0
                };
                
                // Caratteristiche target per ogni voce
                this.voiceTargets = {
                    aria: {
                        tono: { min: 70, max: 90, target: 80 },
                        volume: { min: 65, max: 85, target: 75 },
                        ritmo: { min: 60, max: 80, target: 70 },
                        chiarezza: { min: 75, max: 95, target: 85 }
                    },
                    acqua: {
                        tono: { min: 20, max: 40, target: 30 },
                        volume: { min: 25, max: 45, target: 35 },
                        ritmo: { min: 20, max: 40, target: 30 },
                        chiarezza: { min: 70, max: 90, target: 80 }
                    },
                    terra: {
                        tono: { min: 45, max: 65, target: 55 },
                        volume: { min: 45, max: 65, target: 55 },
                        ritmo: { min: 50, max: 70, target: 60 },
                        chiarezza: { min: 80, max: 100, target: 90 }
                    },
                    fuoco: {
                        tono: { min: 80, max: 100, target: 90 },
                        volume: { min: 85, max: 100, target: 95 },
                        ritmo: { min: 90, max: 100, target: 95 },
                        chiarezza: { min: 70, max: 90, target: 80 }
                    }
                };
                
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.loadProgressData();
                this.updateProgressDisplay();
                this.showNotification('Benvenuto nel sistema di allenamento vocale!', 'info');
                console.log('🎤 Voice Training App inizializzata');
            }
            
            setupEventListeners() {
                // Selezione voce
                document.querySelectorAll('.voice-card').forEach(card => {
                    card.addEventListener('click', () => {
                        this.selectVoice(card.dataset.voice);
                    });
                });
                
                // Pulsante registrazione
                document.getElementById('recordBtn').addEventListener('click', () => {
                    this.toggleRecording();
                });
            }
            
            selectVoice(voiceType) {
                // Rimuovi selezione precedente
                document.querySelectorAll('.voice-card').forEach(card => {
                    card.classList.remove('selected');
                });
                
                // Seleziona nuova voce
                document.querySelector(`[data-voice="${voiceType}"]`).classList.add('selected');
                this.selectedVoice = voiceType;
                
                // Aggiorna status
                document.getElementById('recordingStatus').textContent = `Voce ${voiceType.toUpperCase()} selezionata - Clicca per registrare`;
                
                // Reset feedback
                this.resetFeedback();
                
                this.showNotification(`Voce ${voiceType.toUpperCase()} selezionata`, 'success');
                console.log(`🎯 Voce selezionata: ${voiceType}`);
            }
            
            async toggleRecording() {
                if (!this.selectedVoice) {
                    this.showNotification('Seleziona prima una voce da allenare', 'warning');
                    return;
                }
                
                if (this.isRecording) {
                    this.stopRecording();
                } else {
                    await this.startRecording();
                }
            }
            
            async startRecording() {
                try {
                    // Richiedi permessi microfono
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    this.mediaRecorder = new MediaRecorder(stream);
                    this.audioChunks = [];
                    
                    this.mediaRecorder.addEventListener('dataavailable', event => {
                        this.audioChunks.push(event.data);
                    });
                    
                    this.mediaRecorder.addEventListener('stop', () => {
                        this.processRecording();
                    });
                    
                    this.mediaRecorder.start();
                    this.isRecording = true;
                    this.recordingTime = 0;
                    
                    // Aggiorna UI
                    const recordBtn = document.getElementById('recordBtn');
                    recordBtn.classList.remove('idle');
                    recordBtn.classList.add('recording');
                    recordBtn.textContent = '⏹️';
                    
                    document.getElementById('recordingStatus').textContent = 'Registrazione in corso...';
                    document.getElementById('waveformDisplay').style.display = 'block';
                    
                    // Avvia timer
                    this.timerInterval = setInterval(() => {
                        this.recordingTime++;
                        this.updateTimer();
                        
                        // Limite massimo 30 secondi
                        if (this.recordingTime >= 30) {
                            this.stopRecording();
                        }
                    }, 1000);
                    
                    // Simula analisi in tempo reale
                    this.startRealtimeAnalysis();
                    
                    console.log('🎤 Registrazione avviata');
                    
                } catch (error) {
                    console.error('Errore accesso microfono:', error);
                    this.showNotification('Errore: Impossibile accedere al microfono', 'error');
                }
            }
            
            stopRecording() {
                if (!this.isRecording) return;
                
                this.mediaRecorder.stop();
                this.isRecording = false;
                
                // Ferma timer
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
                
                // Aggiorna UI
                const recordBtn = document.getElementById('recordBtn');
                recordBtn.classList.remove('recording');
                recordBtn.classList.add('processing');
                recordBtn.textContent = '🔄';
                
                document.getElementById('recordingStatus').textContent = 'Elaborazione in corso...';
                
                // Ferma stream
                this.mediaRecorder.stream.getTracks().forEach(track => track.stop());
                
                console.log('🛑 Registrazione terminata');
            }
            
            async processRecording() {
                this.isProcessing = true;
                
                try {
                    // Simula elaborazione (in un'app reale qui ci sarebbe l'analisi ML)
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    // Genera feedback simulato
                    const feedback = this.generateFeedback();
                    
                    // Mostra feedback
                    this.displayFeedback(feedback);
                    
                    // Aggiorna progressi
                    this.updateProgress(feedback);
                    
                    // Reset UI
                    this.resetRecordingUI();
                    
                    this.showNotification('Analisi completata!', 'success');
                    
                } catch (error) {
                    console.error('Errore elaborazione:', error);
                    this.showNotification('Errore durante l\'elaborazione', 'error');
                    this.resetRecordingUI();
                }
                
                this.isProcessing = false;
            }
            
            generateFeedback() {
                const target = this.voiceTargets[this.selectedVoice];
                
                // Genera valori simulati con variazione casuale
                const tono = Math.max(0, Math.min(100, target.tono.target + (Math.random() - 0.5) * 30));
                const volume = Math.max(0, Math.min(100, target.volume.target + (Math.random() - 0.5) * 25));
                const ritmo = Math.max(0, Math.min(100, target.ritmo.target + (Math.random() - 0.5) * 20));
                const chiarezza = Math.max(0, Math.min(100, target.chiarezza.target + (Math.random() - 0.5) * 15));
                
                // Calcola punteggio complessivo
                const score = Math.round((tono + volume + ritmo + chiarezza) / 4);
                
                // Genera suggerimenti basati sui valori
                const suggestions = this.generateSuggestions(tono, volume, ritmo, chiarezza, target);
                
                return {
                    score,
                    metrics: { tono, volume, ritmo, chiarezza },
                    suggestions
                };
            }
            
            generateSuggestions(tono, volume, ritmo, chiarezza, target) {
                const suggestions = [];
                const voiceType = this.selectedVoice;
                
                // Suggerimenti specifici per ogni metrica
                if (Math.abs(tono - target.tono.target) > 15) {
                    if (voiceType === 'aria' && tono < target.tono.target) {
                        suggestions.push('Prova a iniziare con un tono più basso e fallo salire gradualmente');
                    } else if (voiceType === 'acqua' && tono > target.tono.target) {
                        suggestions.push('Lascia che il tono scenda dolcemente, come acqua che scorre');
                    } else if (voiceType === 'terra' && tono > target.tono.target) {
                        suggestions.push('Mantieni un tono più stabile e deciso, evita variazioni eccessive');
                    } else if (voiceType === 'fuoco' && tono < target.tono.target) {
                        suggestions.push('Aumenta l\'energia nel tono, deve essere più incalzante');
                    }
                }
                
                if (Math.abs(volume - target.volume.target) > 15) {
                    if (voiceType === 'aria' && volume < target.volume.target) {
                        suggestions.push('Aumenta gradualmente il volume mentre procedi');
                    } else if (voiceType === 'acqua' && volume > target.volume.target) {
                        suggestions.push('Parla più piano, come in un dialogo intimo');
                    } else if (voiceType === 'fuoco' && volume < target.volume.target) {
                        suggestions.push('Aumenta il volume per trasmettere più energia e decisione');
                    }
                }
                
                if (Math.abs(ritmo - target.ritmo.target) > 15) {
                    if (voiceType === 'terra' && Math.abs(ritmo - target.ritmo.target) > 10) {
                        suggestions.push('Mantieni un ritmo più costante, come una marcia regolare');
                    } else if (voiceType === 'acqua' && ritmo > target.ritmo.target) {
                        suggestions.push('Rallenta il ritmo e aggiungi pause più lunghe');
                    } else if (voiceType === 'fuoco' && ritmo < target.ritmo.target) {
                        suggestions.push('Accelera il ritmo, deve essere più incalzante');
                    }
                }
                
                if (chiarezza < target.chiarezza.target - 10) {
                    suggestions.push('Articola meglio le consonanti per una maggiore chiarezza');
                    suggestions.push('Prova a parlare con la bocca leggermente più aperta');
                }
                
                // Suggerimenti generali se non ci sono problemi specifici
                if (suggestions.length === 0) {
                    suggestions.push('Ottimo lavoro! Continua così per consolidare la tecnica');
                    suggestions.push('Prova a mantenere questa qualità per periodi più lunghi');
                }
                
                return suggestions;
            }
            
            displayFeedback(feedback) {
                const { score, metrics, suggestions } = feedback;
                
                // Aggiorna punteggio
                document.getElementById('scoreValue').textContent = score;
                
                // Aggiorna colore punteggio
                const scoreCircle = document.getElementById('scoreCircle');
                scoreCircle.className = 'score-circle';
                if (score >= 80) {
                    scoreCircle.classList.add('score-excellent');
                } else if (score >= 60) {
                    scoreCircle.classList.add('score-good');
                } else {
                    scoreCircle.classList.add('score-needs-work');
                }
                
                // Aggiorna metriche
                this.updateMetric('tone', metrics.tono);
                this.updateMetric('volume', metrics.volume);
                this.updateMetric('rhythm', metrics.ritmo);
                this.updateMetric('clarity', metrics.chiarezza);
                
                // Mostra suggerimenti
                const suggestionsList = document.getElementById('suggestionsList');
                suggestionsList.innerHTML = '';
                suggestions.forEach(suggestion => {
                    const li = document.createElement('li');
                    li.textContent = suggestion;
                    suggestionsList.appendChild(li);
                });
                
                document.getElementById('suggestions').style.display = 'block';
                
                console.log('📊 Feedback mostrato:', feedback);
            }
            
            updateMetric(type, value) {
                const roundedValue = Math.round(value);
                document.getElementById(`${type}Value`).textContent = roundedValue + '%';
                document.getElementById(`${type}Fill`).style.width = roundedValue + '%';
            }
            
            resetFeedback() {
                document.getElementById('scoreValue').textContent = '--';
                document.getElementById('scoreCircle').className = 'score-circle score-excellent';
                
                ['tone', 'volume', 'rhythm', 'clarity'].forEach(type => {
                    document.getElementById(`${type}Value`).textContent = '--';
                    document.getElementById(`${type}Fill`).style.width = '0%';
                });
                
                document.getElementById('suggestions').style.display = 'none';
            }
            
            resetRecordingUI() {
                const recordBtn = document.getElementById('recordBtn');
                recordBtn.className = 'record-btn idle';
                recordBtn.textContent = '🎤';
                
                document.getElementById('recordingStatus').textContent = 
                    this.selectedVoice ? `Voce ${this.selectedVoice.toUpperCase()} selezionata - Clicca per registrare` : 
                    'Seleziona una voce e clicca per iniziare';
                
                document.getElementById('timer').textContent = '00:00';
                document.getElementById('waveformDisplay').style.display = 'none';
            }
            
            updateTimer() {
                const minutes = Math.floor(this.recordingTime / 60);
                const seconds = this.recordingTime % 60;
                document.getElementById('timer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            startRealtimeAnalysis() {
                const canvas = document.getElementById('waveformCanvas');
                canvas.innerHTML = '';
                
                // Simula visualizzazione in tempo reale
                const colors = {
                    aria: '#74b9ff',
                    acqua: '#00b894',
                    terra: '#fdcb6e',
                    fuoco: '#fd79a8'
                };
                
                const color = colors[this.selectedVoice] || '#3498db';
                
                canvas.innerHTML = `
                    <div style="
                        width: 100%;
                        height: 100%;
                        background: linear-gradient(45deg, ${color}20, ${color}10);
                        border-radius: 8px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        position: relative;
                        overflow: hidden;
                    ">
                        <div style="
                            width: 20px;
                            height: 60%;
                            background: ${color};
                            border-radius: 10px;
                            margin: 0 2px;
                            animation: pulse 0.8s infinite alternate;
                        "></div>
                        <div style="
                            width: 20px;
                            height: 80%;
                            background: ${color};
                            border-radius: 10px;
                            margin: 0 2px;
                            animation: pulse 1.2s infinite alternate;
                        "></div>
                        <div style="
                            width: 20px;
                            height: 40%;
                            background: ${color};
                            border-radius: 10px;
                            margin: 0 2px;
                            animation: pulse 1s infinite alternate;
                        "></div>
                        <div style="
                            width: 20px;
                            height: 70%;
                            background: ${color};
                            border-radius: 10px;
                            margin: 0 2px;
                            animation: pulse 0.9s infinite alternate;
                        "></div>
                        <div style="
                            width: 20px;
                            height: 50%;
                            background: ${color};
                            border-radius: 10px;
                            margin: 0 2px;
                            animation: pulse 1.1s infinite alternate;
                        "></div>
                        <span style="
                            position: absolute;
                            bottom: 10px;
                            right: 10px;
                            font-size: 0.9em;
                            color: ${color};
                            font-weight: 600;
                        ">🎤 Analisi ${this.selectedVoice.toUpperCase()}</span>
                    </div>
                `;
            }
            
            updateProgress(feedback) {
                // Simula aggiornamento progressi
                this.progressData.sessions++;
                
                if (feedback.score > 75) {
                    this.progressData.improvement = Math.min(100, this.progressData.improvement + 2);
                    this.progressData.streak++;
                } else if (feedback.score < 50) {
                    this.progressData.streak = Math.max(0, this.progressData.streak - 1);
                }
                
                this.progressData.accuracy = this.progressData.sessions === 1 ? 
                    feedback.score : 
                    Math.round((this.progressData.accuracy * 0.8 + feedback.score * 0.2));
                
                this.updateProgressDisplay();
                this.saveProgressData();
            }
            
            updateProgressDisplay() {
                document.getElementById('sessionsCount').textContent = this.progressData.sessions;
                document.getElementById('improvementPercent').textContent = 
                    this.progressData.improvement > 0 ? `+${this.progressData.improvement}%` : `${this.progressData.improvement}%`;
                document.getElementById('accuracyPercent').textContent = 
                    this.progressData.accuracy > 0 ? `${this.progressData.accuracy}%` : '--%';
                document.getElementById('streakDays').textContent = this.progressData.streak;
            }
            
            loadProgressData() {
                const saved = localStorage.getItem('voiceBreakProgress');
                if (saved) {
                    try {
                        this.progressData = { ...this.progressData, ...JSON.parse(saved) };
                    } catch (error) {
                        console.warn('Errore caricamento progressi:', error);
                    }
                }
            }
            
            saveProgressData() {
                try {
                    localStorage.setItem('voiceBreakProgress', JSON.stringify(this.progressData));
                } catch (error) {
                    console.warn('Errore salvataggio progressi:', error);
                }
            }
            
            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => notification.classList.add('show'), 100);
                
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }
        }
        
        // Funzioni globali per gli esercizi
        function startExercise(exerciseId) {
            const exercises = {
                'aria-basics': {
                    title: 'Fondamenti dell\'Aria',
                    description: 'Impara a modulare tono ascendente e volume crescente',
                    voice: 'aria',
                    duration: 10
                },
                'acqua-pauses': {
                    title: 'Pause e Fluidità',
                    description: 'Padroneggia pause lunghe e discesa tonale',
                    voice: 'acqua',
                    duration: 15
                },
                'terra-structure': {
                    title: 'Struttura e Stabilità',
                    description: 'Sviluppa costanza ritmica e chiarezza',
                    voice: 'terra',
                    duration: 12
                },
                'fuoco-energy': {
                    title: 'Energia e Velocità',
                    description: 'Affina energia esplosiva e ritmo incalzante',
                    voice: 'fuoco',
                    duration: 20
                }
            };
            
            const exercise = exercises[exerciseId];
            if (!exercise) {
                app.showNotification('Esercizio non trovato', 'error');
                return;
            }
            
            // Seleziona automaticamente la voce dell'esercizio
            app.selectVoice(exercise.voice);
            
            // Mostra dettagli esercizio
            app.showNotification(`Esercizio avviato: ${exercise.title} (${exercise.duration} min)`, 'info');
            
            // Scroll to top per vedere la selezione
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            console.log(`🎯 Esercizio avviato: ${exerciseId}`, exercise);
        }
        
        // Inizializza l'applicazione
        let app;
        document.addEventListener('DOMContentLoaded', () => {
            app = new VoiceTrainingApp();
        });
        
        // Aggiungi stile per l'animazione pulse
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0% { transform: scaleY(0.3); opacity: 0.7; }
                100% { transform: scaleY(1); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
        
        console.log('🚀 Voice Break AI Training System caricato!');
    </script>
</body>
</html>